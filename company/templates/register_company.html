{% extends 'base.html' %}

{# Подключаем CSS файл #}
{% load static %}
<link rel="stylesheet" href="{% static 'css/company.css' %}">

{% block content %}

        <div class="modal fade show company-modal" id="companyRegistrationModal" tabindex="-1" style="display: block;">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h4 class="modal-title mb-0">
                            <i class="bi bi-building-add me-2"></i>
                            {% if is_editing %}
                                Firma bearbeiten: {{ company_name|default:"" }}
                            {% else %}
                                Firma registrieren
                            {% endif %}
                        </h4>
                        <div class="ms-auto">
                            <span class="badge bg-light text-primary fs-6">
                                Schritt <span id="current-step">1</span> von 4
                            </span>
                        </div>
                    </div>

                    <!-- Modal Body -->
                    <div class="modal-body">
                        <!-- Progress Indicator -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="progress company-progress mb-2">
                                    <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 25%"></div>
                                </div>
                                <div class="company-progress-labels">
                                    <span>Grunddaten</span>
                                    <span>Registrierung</span>
                                    <span>Adresse</span>
                                    <span>Kontakte & Details</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs company-tabs" id="companyTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" 
                                        type="button" role="tab" aria-controls="basic" aria-selected="true">
                                    <i class="bi bi-building me-1"></i>Grunddaten
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="registration-tab" data-bs-toggle="tab" data-bs-target="#registration" 
                                        type="button" role="tab" aria-controls="registration" aria-selected="false">
                                    <i class="bi bi-file-text me-1"></i>Registrierung
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="address-tab" data-bs-toggle="tab" data-bs-target="#address" 
                                        type="button" role="tab" aria-controls="address" aria-selected="false">
                                    <i class="bi bi-geo-alt me-1"></i>Adresse
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" 
                                        type="button" role="tab" aria-controls="details" aria-selected="false">
                                    <i class="bi bi-person-vcard me-1"></i>Kontakte & Details
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="companyTabContent">
                            <!-- Form -->
                            <form id="company-form" method="post" class="company-form">
                                {% csrf_token %}
                                
                                <!-- Grunddaten Tab -->
                                <div class="tab-pane fade show active company-tab-pane" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label for="{{ form.company_name.id_for_label }}" class="form-label">
                                                    <i class="bi bi-building"></i>{{ form.company_name.label }}
                                                    {% if form.company_name.field.required %}<span class="text-danger">*</span>{% endif %}
                                                </label>
                                                {{ form.company_name }}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="{{ form.legal_form.id_for_label }}" class="form-label">
                                                    <i class="bi bi-shield-check"></i>{{ form.legal_form.label }}
                                                    {% if form.legal_form.field.required %}<span class="text-danger">*</span>{% endif %}
                                                </label>
                                                {{ form.legal_form }}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.industry.id_for_label }}" class="form-label">
                                                    <i class="bi bi-briefcase"></i>{{ form.industry.label }}
                                                </label>
                                                {{ form.industry }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.country.id_for_label }}" class="form-label">
                                                    <i class="bi bi-globe"></i>{{ form.country.label }}
                                                    {% if form.country.field.required %}<span class="text-danger">*</span>{% endif %}
                                                </label>
                                                {{ form.country }}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="{{ form.description.id_for_label }}" class="form-label">
                                            <i class="bi bi-card-text"></i>{{ form.description.label }}
                                        </label>
                                        {{ form.description }}
                                    </div>
                                </div>

                                <!-- Registrierung Tab -->
                                <div class="tab-pane fade company-tab-pane" id="registration" role="tabpanel" aria-labelledby="registration-tab">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.commercial_register.id_for_label }}" class="form-label">
                                                    <i class="bi bi-file-earmark-text"></i>{{ form.commercial_register.label }}
                                                </label>
                                                {{ form.commercial_register }}
                                                {% if form.commercial_register.help_text %}
                                                <div class="form-text">
                                                    <i class="bi bi-info-circle me-1"></i>{{ form.commercial_register.help_text }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.tax_number.id_for_label }}" class="form-label">
                                                    <i class="bi bi-calculator"></i>{{ form.tax_number.label }}
                                                </label>
                                                {{ form.tax_number }}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.vat_id.id_for_label }}" class="form-label">
                                                    <i class="bi bi-receipt"></i>{{ form.vat_id.label }}
                                                </label>
                                                {{ form.vat_id }}
                                                {% if form.vat_id.help_text %}
                                                <div class="form-text">
                                                    <i class="bi bi-info-circle me-1"></i>{{ form.vat_id.help_text }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Adresse Tab -->
                                <div class="tab-pane fade company-tab-pane" id="address" role="tabpanel" aria-labelledby="address-tab">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label for="{{ form.street.id_for_label }}" class="form-label">
                                                    <i class="bi bi-geo-alt"></i>{{ form.street.label }}
                                                    {% if form.street.field.required %}<span class="text-danger">*</span>{% endif %}
                                                </label>
                                                {{ form.street }}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="{{ form.postal_code.id_for_label }}" class="form-label">
                                                    <i class="bi bi-mailbox"></i>{{ form.postal_code.label }}
                                                    {% if form.postal_code.field.required %}<span class="text-danger">*</span>{% endif %}
                                                </label>
                                                {{ form.postal_code }}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="{{ form.city.id_for_label }}" class="form-label">
                                            <i class="bi bi-buildings"></i>{{ form.city.label }}
                                            {% if form.city.field.required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        {{ form.city }}
                                    </div>
                                </div>

                                <!-- Kontakte & Details Tab -->
                                <div class="tab-pane fade company-tab-pane" id="details" role="tabpanel" aria-labelledby="details-tab">
                                    <!-- Grundkontakte -->
                                    <div class="company-section-card mb-4">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-telephone me-2"></i>Grundkontakte
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.email.id_for_label }}" class="form-label">
                                                            <i class="bi bi-envelope"></i>{{ form.email.label }}
                                                            {% if form.email.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        {{ form.email }}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.phone.id_for_label }}" class="form-label">
                                                            <i class="bi bi-telephone"></i>{{ form.phone.label }}
                                                            {% if form.phone.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        {{ form.phone }}
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.fax.id_for_label }}" class="form-label">
                                                            <i class="bi bi-printer"></i>{{ form.fax.label }}
                                                        </label>
                                                        {{ form.fax }}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.website.id_for_label }}" class="form-label">
                                                            <i class="bi bi-globe"></i>{{ form.website.label }}
                                                        </label>
                                                        {{ form.website }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Zusätzliche Kontakte -->
                                    <div class="company-section-card mb-4">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-person-vcard me-2"></i>Zusätzliche Kontakte
                                                <span class="company-contact-badge" id="additional-contacts-count">0</span>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="company-contact-management">
                                                <div class="text-center py-4">
                                                    <i class="bi bi-person-plus display-4 text-muted mb-3"></i>
                                                    <p class="mb-2"><strong>Zusätzliche Kontakte hinzufügen</strong></p>
                                                    <p class="text-muted small mb-3">Optional: Weitere Kontaktmöglichkeiten für bessere Kommunikation</p>
                                                    <button type="button" class="btn btn-outline-primary company-btn" id="manage-additional-contacts">
                                                        <i class="bi bi-plus-circle me-1"></i>Kontakte verwalten
                                                    </button>
                                                </div>
                                                
                                                <!-- Summary area -->
                                                <div class="company-contact-summary d-none" id="contacts-summary">
                                                    <p class="mb-0" id="contacts-summary-text">Keine zusätzlichen Kontakte hinzugefügt</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Personen -->
                                    <div class="company-section-card mb-4">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-people me-2"></i>Personen
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.ceo_name.id_for_label }}" class="form-label">
                                                            <i class="bi bi-person-badge"></i>{{ form.ceo_name.label }}
                                                        </label>
                                                        {{ form.ceo_name }}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.contact_person.id_for_label }}" class="form-label">
                                                            <i class="bi bi-person-lines-fill"></i>{{ form.contact_person.label }}
                                                        </label>
                                                        {{ form.contact_person }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Einstellungen -->
                                    <div class="company-section-card">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-gear me-2"></i>Einstellungen
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check">
                                                {{ form.is_primary }}
                                                <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                                                    <i class="bi bi-star me-1"></i>{{ form.is_primary.label }}
                                                </label>
                                                {% if form.is_primary.help_text %}
                                                <div class="form-text">{{ form.is_primary.help_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden field for additional contacts data -->
                                <input type="hidden" id="additionalContactsDataInput" name="additional_contacts_data" value="[]">
                            </form>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary company-btn" id="prev-tab-btn" style="display: none;">
                                        <i class="bi bi-arrow-left me-1"></i>Zurück
                                    </button>
                                    
                                    <div class="ms-auto">
                                        <button type="button" class="btn btn-primary company-btn" id="next-tab-btn">
                                            <span id="next-btn-text">
                                                <i class="bi bi-arrow-right me-1"></i>Weiter
                                            </span>
                                        </button>
                                        
                                        <button type="submit" class="btn btn-success company-btn" id="submit-btn" style="display: none;">
                                            <i class="bi bi-building-add me-1"></i>
                                            {% if is_editing %}Firma aktualisieren{% else %}Firma registrieren{% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Additional Contacts Modal -->
    <div class="modal fade company-additional-contacts-modal" id="additionalContactsModal" tabindex="-1" aria-labelledby="additionalContactsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="additionalContactsModalLabel">
                        <i class="bi bi-person-vcard me-2"></i>Zusätzliche Kontakte verwalten
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="bi bi-list-ul me-1"></i>Kontaktliste 
                            <span class="badge bg-primary ms-2" id="modal-contacts-count">0</span>
                        </h6>
                        <button type="button" class="btn btn-primary btn-sm company-btn" id="add-contact-btn">
                            <i class="bi bi-plus me-1"></i>Neuen Kontakt hinzufügen
                        </button>
                    </div>

                    <!-- Contacts Table -->
                    <div class="table-responsive" id="contacts-table-container" style="display: none;">
                        <table class="table table-sm table-hover company-contacts-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Typ</th>
                                    <th>Kontaktdaten</th>
                                    <th>Beschreibung</th>
                                    <th class="text-center">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="contacts-table-body">
                                <!-- Contacts will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div class="text-center py-5 company-empty-contacts-placeholder" id="empty-contacts-placeholder">
                        <i class="bi bi-person-plus display-1 text-muted mb-3"></i>
                        <h5 class="text-muted">Noch keine zusätzlichen Kontakte hinzugefügt</h5>
                        <p class="text-muted mb-4">Zusätzliche Kontakte sind optional und können übersprungen werden.<br>
                           Sie verbessern jedoch die Kommunikationsmöglichkeiten erheblich.</p>
                        <button type="button" class="btn btn-primary company-btn" onclick="document.getElementById('add-contact-btn').click()">
                            <i class="bi bi-plus me-1"></i>Ersten Kontakt hinzufügen
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary company-btn" data-bs-dismiss="modal">
                        <i class="bi bi-x me-1"></i>Schließen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="contactModalLabel">
                        <i class="bi bi-person-plus me-2"></i>Kontakt hinzufügen
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="contactForm">
                        <div class="mb-3">
                            <label for="contactType" class="form-label">
                                <i class="bi bi-tag"></i>Kontakttyp *
                            </label>
                            <select class="form-select" id="contactType" name="contactType" required>
                                <option value="">-- Typ auswählen --</option>
                                <option value="email">E-Mail (zusätzlich)</option>
                                <option value="mobile">Mobil</option>
                                <option value="fax">Fax (zusätzlich)</option>
                                <option value="website">Website (zusätzlich)</option>
                                <option value="linkedin">LinkedIn</option>
                                <option value="xing">XING</option>
                                <option value="other">Sonstige</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>

                        <div class="mb-3">
                            <label for="contactValue" class="form-label">
                                <i class="bi bi-info-circle"></i>Kontaktdaten *
                            </label>
                            <input type="text" class="form-control" id="contactValue" name="contactValue" 
                                   placeholder="Kontaktdaten eingeben..." required>
                            <div class="invalid-feedback"></div>
                            <div class="form-text" id="contactHint">
                                <i class="bi bi-lightbulb me-1"></i>Geben Sie die entsprechenden Kontaktdaten ein
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="contactLabel" class="form-label">
                                <i class="bi bi-card-text"></i>Beschreibung
                            </label>
                            <input type="text" class="form-control" id="contactLabel" name="contactLabel" 
                                   placeholder="z.B. Marketing, Vertrieb...">
                            <div class="form-text">Optionale Beschreibung für diesen Kontakt</div>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="contactImportant" name="contactImportant">
                            <label class="form-check-label" for="contactImportant">
                                <i class="bi bi-star me-1"></i>Als wichtig markieren
                            </label>
                            <div class="form-text">Wichtige Kontakte werden bevorzugt angezeigt</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary company-btn" data-bs-dismiss="modal">
                        <i class="bi bi-x me-1"></i>Abbrechen
                    </button>
                    <button type="button" class="btn btn-primary company-btn" id="saveContactBtn">
                        <i class="bi bi-check me-1"></i>Speichern
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Contact Modal -->
    <div class="modal fade" id="deleteContactModal" tabindex="-1" aria-labelledby="deleteContactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteContactModalLabel">
                        <i class="bi bi-trash me-2"></i>Kontakt löschen
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-warning fs-1 me-3"></i>
                        <div>
                            <h6 class="mb-1">Möchten Sie diesen Kontakt wirklich löschen?</h6>
                            <p class="text-muted mb-0">Diese Aktion kann nicht rückgängig gemacht werden.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary company-btn" data-bs-dismiss="modal">
                        <i class="bi bi-x me-1"></i>Abbrechen
                    </button>
                    <button type="button" class="btn btn-danger company-btn" id="confirmDeleteBtn">
                        <i class="bi bi-trash me-1"></i>Löschen
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Полупрозрачный фон -->
    <div class="modal-backdrop fade show"></div>

    {# Подключаем JS файл #}
    {% load static %}
    <script src="{% static 'js/register_company.js' %}"></script>

{% endblock %}
