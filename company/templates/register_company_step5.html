{% extends 'base.html' %}

{# Подключаем CSS файлы #}
{% load static %}
<link rel="stylesheet" href="{% static 'css/create_admin_step1-3.css' %}">

{# НОВОЕ: загружаем template tags для legal_form #}
{% load company_extras %}

{% block content %}

    <!-- Модальное окно -->
    <div class="modal fade show" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-modal="true" role="dialog" style="display: block;">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="companyModalLabel">
                        <i class="bi bi-check-circle me-2"></i>
                        {{ text.title }}
                    </h5>
                    <span class="badge bg-light text-dark ms-auto">Schritt {{ step }} von 5</span>
                </div>
                <div class="modal-body">

                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        Legen Sie die finalen Einstellungen für Ihre Firma fest und schließen Sie die Registrierung ab.
                        <br><small class="text-muted mt-1">Firma: <strong>{{ company_name }}
                            {% if legal_form %}
                                {{ legal_form|legal_form_display }}
                            {% endif %}
                        </strong></small>
                        <br><small class="text-muted">Kontakte: <strong>{{ contact_count }}</strong> | E-Mail: <strong>{{ primary_email }}</strong></small>
                    </div>

                    <form id="company-step5-form" method="post" action="{% url 'company:register_company_step5' %}">
                        {% csrf_token %}

                        <div class="row">
                            <!-- Firmeneinstellungen -->
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="bi bi-gear me-1"></i>
                                            {{ text.options_title }}
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            {{ form.is_primary }}
                                            <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                                                <strong>{{ form.is_primary.label }}</strong>
                                            </label>
                                            <div class="form-text">{{ form.is_primary.help_text }}</div>
                                        </div>

                                        <div class="form-check mb-3">
                                            {{ form.enable_notifications }}
                                            <label class="form-check-label" for="{{ form.enable_notifications.id_for_label }}">
                                                {{ form.enable_notifications.label }}
                                            </label>
                                            <div class="form-text">{{ form.enable_notifications.help_text }}</div>
                                        </div>

                                        <div class="form-check">
                                            {{ form.enable_marketing }}
                                            <label class="form-check-label" for="{{ form.enable_marketing.id_for_label }}">
                                                {{ form.enable_marketing.label }}
                                            </label>
                                            <div class="form-text">{{ form.enable_marketing.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Datenschutz und Benachrichtigungen -->
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="bi bi-shield-lock me-1"></i>
                                            {{ text.privacy_title }}
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            {{ form.data_protection_consent }}
                                            <label class="form-check-label" for="{{ form.data_protection_consent.id_for_label }}">
                                                <strong>{{ form.data_protection_consent.label }}</strong>
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="form-text">{{ form.data_protection_consent.help_text }}</div>
                                            {% if form.data_protection_consent.errors %}
                                                <div class="invalid-feedback d-block">{{ form.data_protection_consent.errors }}</div>
                                            {% endif %}
                                        </div>

                                        <!-- Datenschutzhinweise -->
                                        <div class="alert alert-warning d-flex flex-column" role="alert">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                                                <strong>Datenschutzhinweise</strong>
                                            </div>
                                            <ul class="mb-0 ps-3 small text-muted">
                                                <li>Daten werden gemäß DSGVO verarbeitet</li>
                                                <li>Jederzeit Widerruf und Löschung möglich</li>
                                                <li>Keine Weitergabe an Dritte ohne Zustimmung</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Prогрессбар -->
                        <div class="mb-3" id="create-company-progress-container" style="display: none;">
                            <label class="form-label" id="company-progress-label">
                                <i class="bi bi-building me-1"></i>
                                Firma wird registriert...
                            </label>
                            <div class="progress">
                                <div id="company-progress" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <!-- Детальная информация -->
                            <div id="company-creation-details" class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-arrow-right me-1"></i>
                                    <span id="current-step">Validierung...</span>
                                </small>
                            </div>
                        </div>

                        <!-- Прочие ошибки -->
                        {% if form.errors %}
                            <div class="alert alert-danger" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Bitte korrigieren Sie die folgenden Fehler:
                                <ul class="mb-0 mt-2">
                                    {% for field, errors in form.errors.items %}
                                        <li>{{ field }}: {{ errors|join:", " }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'company:register_company_step4' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>
                                {{ text.btn_back }}
                            </a>
                            <button type="submit" class="btn btn-success" id="create-company-btn">
                                <i class="bi bi-building me-1"></i>
                                {{ text.btn }}
                            </button>
                        </div>
                    </form>

                </div>
                <div class="modal-footer">
                    <small class="text-muted">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        {{ text.notification }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Полупрозрачный фон -->
    <div class="modal-backdrop fade show"></div>

{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('company-step6-form');
            if (!form) return;

            const submitBtn = document.getElementById('create-company-btn');
            const progressContainer = document.getElementById('create-company-progress-container');
            const progressLabel = document.getElementById('company-progress-label');
            const progressBar = document.getElementById('company-progress');
            const creationDetails = document.getElementById('company-creation-details');
            const currentStep = document.getElementById('current-step');

            let progressInterval = null;
            let creationSteps = [
                'Validierung der Eingaben...',
                'Firmendaten werden gespeichert...',
                'Kontakte werden verarbeitet...',
                'Adresse wird validiert...',
                'Einstellungen werden angewendet...',
                'Firma wird aktiviert...'
            ];
            let currentStepIndex = 0;

            // Обработчик отправки формы
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                // Показываем прогресс и блокируем форму
                showProgress();

                // Создаем FormData для отправки
                const formData = new FormData(form);

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'HX-Request': 'true'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        hideProgress();

                        // Обрабатываем сообщения
                        if (data.messages && data.messages.length > 0) {
                            data.messages.forEach(message => {
                                showToast(message.text, message.tags, message.delay);
                            });

                            // Если есть успешное сообщение, перенаправляем на главную
                            const hasSuccess = data.messages.some(msg => msg.tags === 'success');
                            if (hasSuccess) {
                                // Показываем финальный шаг
                                if (currentStep) {
                                    currentStep.textContent = 'Firma erfolgreich registriert!';
                                }

                                setTimeout(() => {
                                    window.location.href = '/';
                                }, 2000);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка регистрации фирмы:', error);
                        hideProgress();
                        showToast('Kritischer Fehler beim Registrieren der Firma', 'error');
                    });
            });

            function showProgress() {
                if (!submitBtn) return;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Wird registriert...';

                if (progressContainer) {
                    progressContainer.style.display = 'block';
                }

                if (progressLabel) {
                    progressLabel.style.visibility = 'visible';
                }

                if (creationDetails) {
                    creationDetails.style.visibility = 'visible';
                }

                let progress = 0;
                currentStepIndex = 0;

                progressInterval = setInterval(() => {
                    progress += Math.random() * 10;
                    if (progress > 90) progress = 90;

                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }

                    // Обновляем текущий шаг
                    if (currentStep && currentStepIndex < creationSteps.length - 1) {
                        if (progress > (currentStepIndex + 1) * 15) {
                            currentStepIndex++;
                            currentStep.textContent = creationSteps[currentStepIndex];
                        }
                    }
                }, 400);
            }

            function hideProgress() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }

                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-building me-1"></i>{{ text.btn }}';
                }

                // Завершаем прогресс-бар
                if (progressBar) {
                    progressBar.style.width = '100%';
                }

                setTimeout(() => {
                    if (progressContainer) {
                        progressContainer.style.display = 'none';
                    }
                    if (progressBar) {
                        progressBar.style.width = '0%';
                    }
                }, 2000);
            }

            // Глобальная функция для показа тостов (если не определена)
            if (typeof window.showToast === 'undefined') {
                window.showToast = function (message, type = 'info', delay = 5000) {
                    const toast = document.createElement('div');
                    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
                    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    toast.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                    document.body.appendChild(toast);

                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, delay);
                };
            }
        });
    </script>
{% endblock %}