{% extends 'base.html' %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/create_admin_step1-3.css' %}">
{% load company_extras %}

{% block content %}
<div class="modal fade show" id="companyModal" tabindex="-1" aria-modal="true" role="dialog" style="display: block;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-geo-alt me-2"></i>{{ text.title }}
                </h5>
                <span class="badge bg-light text-dark ms-auto">Schritt {{ step }} von 5</span>
                <button type="button" class="btn-close btn-close-white ms-3" onclick="closeModal()"></button>
            </div>

            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle me-2"></i>{{ text.desc }}
                    <br><small class="text-muted mt-1">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tipp:</strong> Sie k√∂nnen entweder PLZ oder Stadt eingeben - das andere Feld wird automatisch aktualisiert
                    </small>
                </div>

                <form method="post" id="company-step3-form"
                      data-url="{% url 'company:register_company_step3' %}"
                      data-next-url="{% url 'company:register_company_step4' %}"
                      data-city-by-plz-url="{% url 'company:get_city_by_plz' %}"
                      data-plz-by-city-url="{% url 'company:get_plz_by_city' %}"
                      data-cities-autocomplete-url="{% url 'company:search_cities_autocomplete' %}"
                      data-plz-ajax-url="{% url 'company:search_plz_ajax' %}">
                    {% csrf_token %}

                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-building me-2"></i>Gesch√§ftsadresse
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Street -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="{{ form.street.id_for_label }}" class="form-label">
                                            <i class="bi bi-signpost me-1"></i>Stra√üe und Hausnummer
                                            <span class="text-danger">*</span>
                                        </label>
                                        {{ form.street }}
                                        <div class="form-text">z.B. Hauptstra√üe 123</div>
                                    </div>
                                </div>
                            </div>

                            <!-- PLZ + City with bidirectional sync -->
                            <div class="row">
                                <!-- PLZ Select2 -->
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="id_postal_code" class="form-label">
                                            <i class="bi bi-mailbox me-1"></i>Postleitzahl (PLZ)
                                            <span class="text-danger">*</span>
                                        </label>
                                        <select name="{{ form.postal_code.name }}"
                                                id="id_postal_code"
                                                class="form-select"
                                                required>
                                            <option></option>
                                            {% if form.postal_code.value %}
                                                <option value="{{ form.postal_code.value }}" selected>
                                                    {{ form.postal_code.value }}
                                                </option>
                                            {% endif %}
                                        </select>
                                        <div class="form-text">
                                            <i class="bi bi-search me-1"></i>
                                            PLZ suchen
                                        </div>
                                    </div>
                                </div>

                                <!-- City Select2 with AJAX -->
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="id_city" class="form-label">
                                            <i class="bi bi-buildings me-1"></i>Stadt
                                            <span class="text-danger">*</span>
                                        </label>
                                        <select name="city"
                                                id="id_city"
                                                class="form-select"
                                                required>
                                            <option></option>
                                            {% if form.city.value %}
                                                <option value="{{ form.city.value }}" selected>
                                                    {{ form.city.value }}
                                                </option>
                                            {% endif %}
                                        </select>
                                        <div class="form-text">
                                            <i class="bi bi-search me-1"></i>
                                            Stadt eingeben (mind. 2 Zeichen) - PLZ wird gefiltert
                                        </div>
                                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ PLZ –ø–æ –≥–æ—Ä–æ–¥—É -->
                                        <div id="plz-results" class="mt-2" style="display: none;">
                                            <small class="text-success">
                                                <i class="bi bi-check-circle me-1"></i>
                                                <span id="plz-count"></span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Country -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="id_country" class="form-label">
                                            <i class="bi bi-globe-europe-africa me-1"></i>Land
                                            <span class="text-danger">*</span>
                                        </label>
                                        <select name="{{ form.country.name }}"
                                                id="id_country"
                                                class="form-select"
                                                required>
                                            <option></option>
                                            {% for value, text in form.country.field.choices %}
                                                {% if value %}
                                                    <option value="{{ value }}"
                                                            {% if form.country.value == value or text == "Deutschland" %}selected{% endif %}>
                                                        {{ text }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <a href="{% url 'company:register_company_step2' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Zur√ºck
                        </a>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-success" id="save-and-close-btn">
                                <i class="bi bi-check-circle me-1"></i>Sichern & Schlie√üen
                            </button>
                            <button type="submit" class="btn btn-success" id="continue-btn">
                                <i class="bi bi-arrow-right me-1"></i>Weiter
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop fade show"></div>
{% endblock %}

{% block extra_js %}
<script>
// ==================== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ====================

$(document).ready(function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π —Å–≤—è–∑–∏ PLZ ‚Üî Stadt');
    $.fn.select2.defaults.set('language', 'de');

    const form = $('#company-step3-form');
    const cityByPlzUrl = form.data('city-by-plz-url');
    const plzByCityUrl = form.data('plz-by-city-url');
    const citiesAutocompleteUrl = form.data('cities-autocomplete-url');
    const plzAjaxUrl = form.data('plz-ajax-url');

    // ==================== PLZ Select2 —Å AJAX –ø–æ–∏—Å–∫–æ–º ====================
    const plzSelect = $('#id_postal_code').select2({
        theme: 'bootstrap-5',
        placeholder: 'PLZ eingeben (mind. 2 Zeichen)...',
        allowClear: true,
        width: '100%',
        dropdownParent: $('#companyModal'),
        minimumInputLength: 2,  // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ —Å 2 —Å–∏–º–≤–æ–ª–æ–≤
        language: {
            noResults: () => 'Keine PLZ gefunden',
            searching: () => 'Suche l√§uft...',
            inputTooShort: () => 'Bitte mindestens 2 Zeichen eingeben',
            removeAllItems: () => 'Auswahl entfernen',
            loadingMore: () => 'Weitere Ergebnisse laden...'
        },
        ajax: {
            url: plzAjaxUrl,
            dataType: 'json',
            delay: 300,  // Debounce
            data: function(params) {
                return {
                    q: params.term,  // –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
                    page: params.page || 1
                };
            },
            processResults: function(data, params) {
                params.page = params.page || 1;

                return {
                    results: data.results,
                    pagination: {
                        more: data.pagination.more
                    }
                };
            },
            cache: true
        }
    });

    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ PLZ ‚Üí –ø–æ–ª—É—á–∞–µ–º –≥–æ—Ä–æ–¥
    plzSelect.on('select2:select', function(e) {
        handlePlzSelect(e);
    });

    // –ü—Ä–∏ –æ—á–∏—Å—Ç–∫–µ PLZ ‚Üí –æ—á–∏—â–∞–µ–º –≥–æ—Ä–æ–¥
    plzSelect.on('select2:clear', function() {
        handlePlzClear();
    });

    // ==================== Stadt Select2 —Å AJAX –ø–æ–∏—Å–∫–æ–º ====================
    const citySelect = $('#id_city').select2({
        theme: 'bootstrap-5',
        placeholder: 'Stadt eingeben (mind. 2 Zeichen)...',
        allowClear: true,
        width: '100%',
        dropdownParent: $('#companyModal'),
        minimumInputLength: 2,
        language: {
            noResults: () => 'Keine Stadt gefunden',
            searching: () => 'Suche l√§uft...',
            inputTooShort: () => 'Bitte mindestens 2 Zeichen eingeben',
            removeAllItems: () => 'Auswahl entfernen'
        },
        ajax: {
            url: citiesAutocompleteUrl,
            dataType: 'json',
            delay: 300,
            data: function(params) {
                return {
                    q: params.term
                };
            },
            processResults: function(data) {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∞—Å—Å–∏–≤ –≥–æ—Ä–æ–¥–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç Select2
                return {
                    results: data.cities.map(city => ({
                        id: city,
                        text: city
                    }))
                };
            },
            cache: true
        },
        // –†–∞–∑—Ä–µ—à–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ–ø—Ü–∏–π (–µ—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω)
        tags: false
    });

    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ Stadt ‚Üí —Ñ–∏–ª—å—Ç—Ä—É–µ–º PLZ
    citySelect.on('select2:select', function(e) {
        handleCitySelect(e);
    });

    // –ü—Ä–∏ –æ—á–∏—Å—Ç–∫–µ Stadt ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ PLZ
    citySelect.on('select2:clear', function() {
        handleCityClear();
    });

    // ==================== Country Select2 ====================
    $('#id_country').select2({
        theme: 'bootstrap-5',
        placeholder: 'Land ausw√§hlen...',
        allowClear: true,
        width: '100%',
        dropdownParent: $('#companyModal'),
        language: {
            noResults: () => 'Keine Ergebnisse gefunden',
            searching: () => 'Suche l√§uft...'
        }
    }).on('select2:select', function(e) {
        $(this).removeClass('is-invalid').addClass('is-valid');
    });

    console.log('‚úÖ Select2 –∏ –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–≤—è–∑—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
});

// ==================== –§—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ PLZ ====================

function filterPlzByCity(results, autoSelectFirst = false) {
    const plzSelect = $('#id_postal_code');

    console.log('üîß –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è PLZ - –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Å—Ç–∞—Ç–∏—á–Ω—ã–π —Ä–µ–∂–∏–º');

    // ‚úÖ –®–ê–ì 1: –£–Ω–∏—á—Ç–æ–∂–∞–µ–º Select2
    if (plzSelect.data('select2')) {
        plzSelect.select2('destroy');
    }

    // ‚úÖ –®–ê–ì 2: –ö–†–ò–¢–ò–ß–ù–û - –æ—á–∏—â–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π select —ç–ª–µ–º–µ–Ω—Ç
    plzSelect.empty();
    plzSelect.val('');
    plzSelect.prop('selectedIndex', -1);

    // ‚úÖ –®–ê–ì 3: –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é –æ–ø—Ü–∏—é
    plzSelect.append(new Option('', '', false, false));

    // ‚úÖ –®–ê–ì 4: –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ PLZ
    results.forEach(item => {
        plzSelect.append(new Option(
            item.plz_name_long,
            item.plz_code,
            false,
            false
        ));
    });

    // ‚úÖ –®–ê–ì 5: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—ã–π Select2 –ë–ï–ó AJAX
    plzSelect.select2({
        theme: 'bootstrap-5',
        placeholder: 'PLZ ausw√§hlen...',
        allowClear: true,
        width: '100%',
        dropdownParent: $('#companyModal'),
        language: {
            noResults: () => 'Keine PLZ in dieser Liste',
            searching: () => 'Suche l√§uft...'
        }
    }).on('select2:select', function(e) {
        handlePlzSelect(e);
    }).on('select2:clear', function() {
        handlePlzClear();
    });

    // ‚úÖ –®–ê–ì 6: –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ù–ï –∞–≤—Ç–æ–≤—ã–±–æ—Ä
    if (!autoSelectFirst) {
        setTimeout(() => {
            plzSelect.val('').trigger('change.select2');
            plzSelect.removeClass('is-valid is-invalid');
        }, 50);
    }

    console.log(`‚úÖ PLZ gefiltert: ${results.length} Ergebnisse`);

    // ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–º–∏—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    return new Promise((resolve) => {
        setTimeout(() => resolve(), 100);
    });
}

function restoreAllPlzOptions() {
    const plzSelect = $('#id_postal_code');
    const citySelect = $('#id_city');
    const form = $('#company-step3-form');
    const plzAjaxUrl = form.data('plz-ajax-url');
    const citiesAutocompleteUrl = form.data('cities-autocomplete-url');

    console.log('üîÑ Wiederherstellung AJAX-Modus f√ºr PLZ und Stadt');

    // === PLZ: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º AJAX —Ä–µ–∂–∏–º ===
    if (plzSelect.data('select2')) {
        plzSelect.select2('destroy');
    }

    // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    plzSelect.empty();
    plzSelect.val('');
    plzSelect.prop('selectedIndex', -1);
    plzSelect.append(new Option('', '', true, true));

    plzSelect.select2({
        theme: 'bootstrap-5',
        placeholder: 'PLZ eingeben (mind. 2 Zeichen)...',
        allowClear: true,
        width: '100%',
        dropdownParent: $('#companyModal'),
        minimumInputLength: 2,
        language: {
            noResults: () => 'Keine PLZ gefunden',
            searching: () => 'Suche l√§uft...',
            inputTooShort: () => 'Bitte mindestens 2 Zeichen eingeben',
            removeAllItems: () => 'Auswahl entfernen',
            loadingMore: () => 'Weitere Ergebnisse laden...'
        },
        ajax: {
            url: plzAjaxUrl,
            dataType: 'json',
            delay: 300,
            data: function(params) {
                return {
                    q: params.term,
                    page: params.page || 1
                };
            },
            processResults: function(data, params) {
                params.page = params.page || 1;
                return {
                    results: data.results,
                    pagination: {
                        more: data.pagination.more
                    }
                };
            },
            cache: true
        }
    }).on('select2:select', function(e) {
        handlePlzSelect(e);
    }).on('select2:clear', function() {
        handlePlzClear();
    });

    // ‚úÖ –§–ò–ù–ê–õ–¨–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç
    setTimeout(() => {
        plzSelect.val('').trigger('change.select2');
        plzSelect.removeClass('is-valid is-invalid');
    }, 50);

    // === Stadt: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º AJAX —Ä–µ–∂–∏–º ===
    if (citySelect.data('select2')) {
        citySelect.select2('destroy');
    }

    citySelect.empty();
    citySelect.val('');
    citySelect.prop('selectedIndex', -1);
    citySelect.append(new Option('', '', true, true));

    citySelect.select2({
        theme: 'bootstrap-5',
        placeholder: 'Stadt eingeben (mind. 2 Zeichen)...',
        allowClear: true,
        width: '100%',
        dropdownParent: $('#companyModal'),
        minimumInputLength: 2,
        language: {
            noResults: () => 'Keine Stadt gefunden',
            searching: () => 'Suche l√§uft...',
            inputTooShort: () => 'Bitte mindestens 2 Zeichen eingeben',
            removeAllItems: () => 'Auswahl entfernen'
        },
        ajax: {
            url: citiesAutocompleteUrl,
            dataType: 'json',
            delay: 300,
            data: function(params) {
                return {
                    q: params.term
                };
            },
            processResults: function(data) {
                return {
                    results: data.cities.map(city => ({
                        id: city,
                        text: city
                    }))
                };
            },
            cache: true
        }
    }).on('select2:select', function(e) {
        handleCitySelect(e);
    }).on('select2:clear', function() {
        handleCityClear();
    });

    setTimeout(() => {
        citySelect.val('').trigger('change.select2');
        citySelect.removeClass('is-valid is-invalid');
    }, 50);

    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    $('#plz-results').hide();

    console.log('‚úÖ AJAX-Modus wiederhergestellt (alle Werte –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û —É–¥–∞–ª–µ–Ω—ã)');
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π PLZ
function handlePlzSelect(e) {
    const plzCode = e.params.data.id;
    const form = $('#company-step3-form');
    const cityByPlzUrl = form.data('city-by-plz-url');

    console.log('‚úÖ PLZ ausgew√§hlt:', plzCode);

    // –ü–æ–ª—É—á–∞–µ–º –≥–æ—Ä–æ–¥ –ø–æ PLZ
    fetch(`${cityByPlzUrl}?plz=${plzCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ Stadt Select2
                const citySelect = $('#id_city');

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –æ–ø—Ü–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                if (citySelect.find(`option[value="${data.city}"]`).length === 0) {
                    const newOption = new Option(data.city, data.city, true, true);
                    citySelect.append(newOption);
                } else {
                    citySelect.val(data.city);
                }

                citySelect.trigger('change').addClass('is-valid');
                console.log('‚úÖ Stadt automatisch ausgef√ºllt:', data.city);
            }
        })
        .catch(error => console.error('Fehler beim Laden der Stadt:', error));

    $('#id_postal_code').removeClass('is-invalid').addClass('is-valid');
}

function handlePlzClear() {
    console.log('üóëÔ∏è PLZ gel√∂scht - –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å PLZ und Stadt');

    const plzSelect = $('#id_postal_code');
    const citySelect = $('#id_city');
    const form = $('#company-step3-form');
    const plzAjaxUrl = form.data('plz-ajax-url');

    // ‚úÖ –û—á–∏—â–∞–µ–º Stadt —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
    const hadCity = citySelect.val() !== null && citySelect.val() !== '';
    if (citySelect.data('select2')) {
        citySelect.val(null).trigger('change');
    }
    citySelect.removeClass('is-valid is-invalid');

    // –û—á–∏—â–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é PLZ
    plzSelect.removeClass('is-valid is-invalid');

    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
    $('#plz-results').hide();

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º AJAX —Ä–µ–∂–∏–º –¥–ª—è PLZ
    if (plzSelect.data('select2')) {
        plzSelect.select2('destroy');
    }

    plzSelect.empty();
    plzSelect.val('');
    plzSelect.prop('selectedIndex', -1);
    plzSelect.append(new Option('', '', true, true));

    plzSelect.select2({
        theme: 'bootstrap-5',
        placeholder: 'PLZ eingeben (mind. 2 Zeichen)...',
        allowClear: true,
        width: '100%',
        dropdownParent: $('#companyModal'),
        minimumInputLength: 2,
        language: {
            noResults: () => 'Keine PLZ gefunden',
            searching: () => 'Suche l√§uft...',
            inputTooShort: () => 'Bitte mindestens 2 Zeichen eingeben',
            removeAllItems: () => 'Auswahl entfernen',
            loadingMore: () => 'Weitere Ergebnisse laden...'
        },
        ajax: {
            url: plzAjaxUrl,
            dataType: 'json',
            delay: 300,
            data: function(params) {
                return {
                    q: params.term,
                    page: params.page || 1
                };
            },
            processResults: function(data, params) {
                params.page = params.page || 1;
                return {
                    results: data.results,
                    pagination: {
                        more: data.pagination.more
                    }
                };
            },
            cache: true
        }
    }).on('select2:select', function(e) {
        handlePlzSelect(e);
    }).on('select2:clear', function() {
        handlePlzClear();
    });

    setTimeout(() => {
        plzSelect.val('').trigger('change.select2');
    }, 50);

    // ‚úÖ –ù–û–í–û–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –≥–æ—Ä–æ–¥ –±—ã–ª –≤—ã–±—Ä–∞–Ω
    if (hadCity) {
        showToast('PLZ und Stadt zur√ºckgesetzt', 'info', 2000);
    }

    console.log('‚úÖ PLZ und Stadt vollst√§ndig zur√ºckgesetzt');
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Stadt
function handleCitySelect(e) {
    const cityName = e.params.data.text;
    const form = $('#company-step3-form');
    const plzByCityUrl = form.data('plz-by-city-url');

    console.log('‚úÖ Stadt ausgew√§hlt:', cityName);

    // –ü–æ–ª—É—á–∞–µ–º PLZ –ø–æ –≥–æ—Ä–æ–¥—É
    fetch(`${plzByCityUrl}?city=${encodeURIComponent(cityName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.results.length > 0) {
                // ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ –∞–≤—Ç–æ–≤—ã–±–æ—Ä
                const autoSelect = data.results.length === 1;

                // –§–∏–ª—å—Ç—Ä—É–µ–º PLZ –∏ –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                filterPlzByCity(data.results, autoSelect).then(() => {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    $('#plz-results').show();
                    $('#plz-count').text(`${data.count} PLZ gefunden f√ºr "${cityName}"`);

                    // ‚úÖ –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω PLZ - –≤—ã–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    if (autoSelect) {
                        const plzCode = data.results[0].plz_code;
                        const plzText = data.results[0].plz_name_long;

                        console.log('üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä PLZ:', plzCode);

                        // –î–∞–µ–º Select2 –≤—Ä–µ–º—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        setTimeout(() => {
                            const plzSelect = $('#id_postal_code');

                            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –æ–ø—Ü–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                            if (plzSelect.find(`option[value="${plzCode}"]`).length === 0) {
                                const newOption = new Option(plzText, plzCode, true, true);
                                plzSelect.append(newOption);
                            }

                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                            plzSelect.val(plzCode).trigger('change');

                            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                            plzSelect.addClass('is-valid');

                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            showToast(`PLZ ${plzCode} automatisch ausgew√§hlt`, 'success', 3000);

                            console.log('‚úÖ PLZ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω:', plzCode);
                        }, 200); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                    }

                    $('#id_city').addClass('is-valid');
                });
            } else {
                showToast('Keine PLZ f√ºr diese Stadt gefunden', 'warning');
                $('#id_city').removeClass('is-valid');
            }
        })
        .catch(error => {
            console.error('Fehler bei PLZ-Suche:', error);
            showToast('Fehler beim Suchen der PLZ', 'error');
        });
}

function handleCityClear() {
    console.log('üóëÔ∏è Stadt gel√∂scht - –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å Stadt und PLZ');

    const plzSelect = $('#id_postal_code');
    const citySelect = $('#id_city');

    // –û—á–∏—â–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –æ–±–æ–∏—Ö –ø–æ–ª–µ–π
    plzSelect.removeClass('is-valid is-invalid');
    citySelect.removeClass('is-valid is-invalid');

    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    $('#plz-results').hide();

    // ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º AJAX —Ä–µ–∂–∏–º –¥–ª—è –û–ë–û–ò–• –ø–æ–ª–µ–π
    restoreAllPlzOptions();

    console.log('‚úÖ Stadt und PLZ vollst√§ndig zur√ºckgesetzt');
}

function closeModal() {
    if (confirm('M√∂chten Sie das Fenster schlie√üen? Ungesicherte √Ñnderungen gehen verloren.')) {
        window.location.href = '/';
    }
}
</script>

<script src="{% static 'js/register_company_step3.js' %}"></script>
{% endblock %}