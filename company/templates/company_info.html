{% extends 'base.html' %}
{% load static %}
{% load company_extras %}

{% block title %}Firmendaten{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/create_admin_step1-3.css' %}">
    <link rel="stylesheet" href="{% static 'css/company_info.css' %}">
{% endblock %}

{% block content %}
    <div class="container-fluid py-4">

        <!-- Header с основной информацией -->
        <div class="company-info-card card mb-4">
            <div class="company-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-2">
                            <i class="bi bi-building me-3"></i>
                            {{ company.company_name|default:"Firmenname nicht verfügbar" }} {{ company_legal_form }}
                        </h1>
                    </div>
                    <div class="col-md-4">
                        {% if stats %}
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="stat-card">
                                        <div class="h4 mb-1">{{ stats.filled_fields }}/{{ stats.total_fields }}</div>
                                        <small>Felder ausgefüllt</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card">
                                        <div class="h4 mb-1">{{ stats.additional_contacts_count }}</div>
                                        <small>Zusätzliche Kontakte</small>
                                    </div>
                                </div>
                            </div>
                            <div class="completion-bar mt-3">
                                <div class="completion-fill" style="width: {{ stats.completion_percentage }}%"></div>
                                <div class="completion-text">{{ stats.completion_percentage }}% vollständig</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Grunddaten -->
            <div class="col-lg-6">
                <!-- ОБНОВЛЕНО: Добавлена кнопка редактирования Grunddaten -->
                <div class="section-card">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Grunddaten
                        </h5>
                        <a href="{% url 'company:edit_company_step1' %}" class="btn btn-sm btn-outline-light" title="Grunddaten bearbeiten">
                            <i class="bi bi-pencil me-1"></i>
                            Bearbeiten
                        </a>
                    </div>
                    <div class="card-body p-0">

                        <div class="field-row">
                            <div class="field-label">Firmenname</div>
                            <div class="field-value">
                                <span class="{% if not company.company_name %}field-empty{% endif %}">
                                    {{ company.company_name|default:"Nicht angegeben" }}
                                </span>
                                <span class="{% if not company_legal_form %}field-empty{% endif %}">
                                    {{ company_legal_form|default:"Nicht angegeben" }}
                                </span>
                            </div>
                        </div>

                        <div class="field-row">
                            <div class="field-label">Geschäftsführer</div>
                            <div class="field-value">
                                {% if company.ceo_salutation or company.ceo_title or company.ceo_first_name or company.ceo_last_name %}
                                    {% if company.ceo_salutation %}{{ company.ceo_salutation|salutation_display }} {% endif %}
                                    {% if company.ceo_title %}{{ company.ceo_title|title_display }} {% endif %}
                                    {{ company.ceo_first_name|default:"" }} {{ company.ceo_last_name|default:"" }}
                                {% else %}
                                    <span class="field-empty">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ОБНОВЛЕНО: Добавлена кнопка редактирования Registrierungsdaten -->
                <div class="section-card">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            Registrierungsdaten
                        </h5>
                        <a href="{% url 'company:edit_company_step2' %}" class="btn btn-sm btn-outline-light" title="Registrierungsdaten bearbeiten">
                            <i class="bi bi-pencil me-1"></i>
                            Bearbeiten
                        </a>
                    </div>

                    <div class="card-body p-0">

                        <div class="field-row">
                            <div class="row">
                                <div class="col-6">
                                    <div class="field-label">Handelsregister</div>
                                    <div class="field-value{% if not company.commercial_register %} field-empty{% endif %}">
                                        {{ company.commercial_register|default:"Nicht angegeben" }}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="field-label">Steuernummer</div>
                                    <div class="field-value{% if not company.tax_number %} field-empty{% endif %}">
                                        {{ company.tax_number|default:"Nicht angegeben" }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="field-row">
                            <div class="row">
                                <div class="col-6">
                                    <div class="field-label">USt-IdNr.</div>
                                    <div class="field-value{% if not company.vat_id %} field-empty{% endif %}">
                                        {{ company.vat_id|default:"Nicht angegeben" }}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="field-label">Steuer-ID</div>
                                    <div class="field-value{% if not company.tax_id %} field-empty{% endif %}">
                                        {{ company.tax_id|default:"Nicht angegeben" }}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ОБНОВЛЕНО: Добавлена кнопка редактирования Bankverbindungen -->
                {% if has_banking_data %}
                    <div class="section-card">
                        <div class="section-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-bank me-2"></i>
                                Bankverbindungen
                            </h5>
                            <a href="{% url 'company:edit_company_step5' %}" class="btn btn-sm btn-outline-light" title="Bankdaten bearbeiten">
                                <i class="bi bi-pencil me-1"></i>
                                Bearbeiten
                            </a>
                        </div>
                        <div class="card-body p-0">
                            <div class="field-row">
                                <div class="field-label">Bank</div>
                                <div class="field-value{% if not company.bank_name %} field-empty{% endif %}">{{ company.bank_name|default:"Nicht angegeben" }}</div>
                            </div>
                            <div class="field-row">
                                <div class="field-label">IBAN</div>
                                <div class="field-value{% if not company.iban %} field-empty{% endif %}">{{ company.iban|default:"Nicht angegeben" }}</div>
                            </div>

                            <div class="field-row">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="field-label">BIC</div>
                                        <div class="field-value{% if not company.bic %} field-empty{% endif %}">
                                            {{ company.bic|default:"Nicht angegeben" }}
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="field-label">Kontoinhaber</div>
                                        <div class="field-value{% if not company.account_holder %} field-empty{% endif %}">
                                            {{ company.account_holder|default:"Nicht angegeben" }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if company.secondary_bank_name or company.secondary_iban %}
                                <div class="field-row" style="margin-top: 1rem; border-top: 1px solid rgba(33, 150, 243, 0.2); padding-top: 1rem;">
                                    <div class="field-label">Zweitbank</div>
                                    <div class="field-value{% if not company.secondary_bank_name %} field-empty{% endif %}">{{ company.secondary_bank_name|default:"Nicht angegeben" }}</div>
                                </div>
                                {% if company.secondary_iban %}
                                    <div class="field-row">
                                        <div class="field-label">IBAN (Zweitbank)</div>
                                        <div class="field-value">{{ company.secondary_iban }}</div>
                                    </div>
                                {% endif %}
                                {% if company.secondary_bic %}
                                    <div class="field-row">
                                        <div class="field-label">BIC (Zweitbank)</div>
                                        <div class="field-value">{{ company.secondary_bic }}</div>
                                    </div>
                                {% endif %}
                            {% endif %}
                            {% if company.banking_notes %}
                                <div class="field-row">
                                    <div class="field-label">Notizen</div>
                                    <div class="field-value">{{ company.banking_notes|linebreaks }}</div>
                                </div>{% endif %}
                        </div>
                    </div>
                {% else %}
                    <!-- НОВОЕ: Секция для добавления банковских данных, если их нет -->
                    <div class="section-card">
                        <div class="section-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-bank me-2"></i>
                                Bankverbindungen
                            </h5>
                            <a href="{% url 'company:edit_company_step5' %}" class="btn btn-sm btn-outline-light" title="Bankdaten hinzufügen">
                                <i class="bi bi-plus-circle me-1"></i>
                                Hinzufügen
                            </a>
                        </div>
                        <div class="card-body p-0">
                            <div class="field-row">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-bank2 display-6 mb-3"></i>
                                    <p class="mb-2"><strong>Keine Bankverbindungen hinterlegt</strong></p>
                                    <p class="mb-0 small">Bankdaten erleichtern die Rechnungsstellung</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

            </div>

            <!-- Adresse und Kontakt -->
            <div class="col-lg-6">
                <!-- ОБНОВЛЕНО: Добавлена кнопка редактирования Geschäftsadresse -->
                <div class="section-card">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-geo-alt me-2"></i>
                            Geschäftsadresse
                        </h5>
                        <a href="{% url 'company:edit_company_step3' %}" class="btn btn-sm btn-outline-light" title="Adressdaten bearbeiten">
                            <i class="bi bi-pencil me-1"></i>
                            Bearbeiten
                        </a>
                    </div>

                    <div class="card-body p-0">

                        <div class="field-row">
                            <div class="row">
                                <div class="col-6">
                                    <div class="field-label">Straße</div>
                                    <div class="field-value{% if not company.street %} field-empty{% endif %}">
                                        {{ company.street|default:"Nicht angegeben" }}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="field-label">PLZ / Stadt</div>
                                    <div class="field-value">
                                        {% if company.postal_code and company.city %}
                                            {{ company.postal_code }} {{ company.city }}
                                        {% else %}
                                            <span class="field-empty">Nicht vollständig angegeben</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="field-row">
                            <div class="field-label">Land</div>
                            <div class="field-value{% if not company.country %} field-empty{% endif %}">
                                {{ company.country|default:"Nicht angegeben" }}
                            </div>
                        </div>
                        {% if company.address_addition %}
                            <div class="field-row">
                                <div class="field-label">Adresszusatz</div>
                                <div class="field-value">{{ company.address_addition }}</div>
                            </div>
                        {% endif %}
                        {% if company.po_box %}
                            <div class="field-row">
                                <div class="field-label">Postfach</div>
                                <div class="field-value">{{ company.po_box }}</div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- ОБНОВЛЕНО: Добавлена кнопка редактирования Hauptkontakte -->
                <div class="section-card">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-telephone me-2"></i>
                            Hauptkontakte
                        </h5>
                        <a href="{% url 'company:edit_company_step4' %}" class="btn btn-sm btn-outline-light" title="Kontaktdaten bearbeiten">
                            <i class="bi bi-pencil me-1"></i>
                            Bearbeiten
                        </a>
                    </div>
                    <div class="card-body p-0">

                        <div class="field-row">
                            <div class="row">
                                <div class="col-6">
                                    <div class="field-label">E-Mail</div>
                                    <div class="field-value">
                                        {% if company.email %}
                                            <a href="mailto:{{ company.email }}">{{ company.email }}</a>
                                        {% else %}
                                            <span class="field-empty">Nicht angegeben</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="field-label">Telefon</div>
                                    <div class="field-value">
                                        {% if company.phone %}
                                            <a href="tel:{{ company.phone }}">{{ company.phone }}</a>
                                        {% else %}
                                            <span class="field-empty">Nicht angegeben</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if company.fax or company.website %}
                            <div class="field-row">
                                <div class="row">
                                    {% if company.fax %}
                                        <div class="col-6">
                                            <div class="field-label">Fax</div>
                                            <div class="field-value">{{ company.fax }}</div>
                                        </div>
                                    {% endif %}
                                    {% if company.website %}
                                        <div class="col-{% if company.fax %}6{% else %}12{% endif %}">
                                            <div class="field-label">Website</div>
                                            <div class="field-value">
                                                <a href="{{ company.website }}" target="_blank" rel="noopener">
                                                    {{ company.website }}
                                                    <i class="bi bi-box-arrow-up-right ms-1"></i>
                                                </a>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}

                    </div>
                </div>

                <!-- Zusätzliche Kontakte (редактируются вместе с основными в шаге 4) -->
                {% if additional_contacts %}
                    <div class="section-card">
                        <div class="section-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-person-lines-fill me-2"></i>
                                Zusätzliche Kontakte
                                <span class="badge bg-primary ms-2">{{ additional_contacts|length }}</span>
                            </h5>
                            <a href="{% url 'company:edit_company_step4' %}" class="btn btn-sm btn-outline-light" title="Zusätzliche Kontakte bearbeiten">
                                <i class="bi bi-pencil me-1"></i>
                                Bearbeiten
                            </a>
                        </div>
                        <div class="card-body p-0">
                            {% for contact in additional_contacts %}
                                <div class="field-row">
                                    <div class="field-label">{{ contact.type|capfirst }}</div>
                                    <div class="field-value">{{ contact.value }}{% if contact.label %} ({{ contact.label }}){% endif %}{% if contact.important %} – <strong>Wichtig</strong>{% endif %}{% if contact.public %} –
                                        <em>Öffentlich</em>{% else %} – <em>Intern</em>{% endif %}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>

        </div>

        <!-- Metadaten -->
        {% if stats %}
            <div class="section-card">
                <div class="section-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-square me-2"></i>
                        Systemdaten
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if stats.created_at %}
                        <div class="field-row">
                            <div class="field-label">Erstellt am</div>
                            <div class="field-value">{{ stats.created_at|date:"d.m.Y H:i" }} Uhr</div>
                        </div>
                    {% endif %}
                    {% if stats.modified_at %}
                        <div class="field-row">
                            <div class="field-label">Zuletzt geändert</div>
                            <div class="field-value">{{ stats.modified_at|date:"d.m.Y H:i" }} Uhr</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

{#        <!-- ОБНОВЛЕННЫЕ Floating Action Buttons -->#}
{#        <div class="action-buttons">#}
{#            <div class="container-fluid">#}
{#                <div class="row justify-content-end">#}
{#                    <div class="col-auto">#}
{#                        <div class="floating-actions">#}
{#                            <!-- НОВОЕ: Кнопка полного редактирования -->#}
{#                            <a href="{% url 'company:edit_company' %}" class="btn btn-warning btn-sm" title="Alle Daten bearbeiten">#}
{#                                <i class="bi bi-pencil-square me-1"></i>#}
{#                                Alle Daten#}
{#                            </a>#}
{#                            <a href="{% url 'company:export_company_data' %}" class="btn btn-info btn-sm">#}
{#                                <i class="bi bi-download me-1"></i>#}
{#                                Exportieren#}
{#                            </a>#}
{#                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteCompanyModal">#}
{#                                <i class="bi bi-trash me-1"></i>#}
{#                                Löschen#}
{#                            </button>#}
{#                        </div>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}

    </div>

{#    <!-- Modal für Löschen bestätigen -->#}
{#    <div class="modal fade" id="deleteCompanyModal" tabindex="-1" aria-labelledby="deleteCompanyModalLabel" aria-hidden="true">#}
{#        <div class="modal-dialog modal-dialog-centered">#}
{#            <div class="modal-content">#}
{#                <div class="modal-header bg-danger text-white">#}
{#                    <h5 class="modal-title" id="deleteCompanyModalLabel">#}
{#                        <i class="bi bi-exclamation-triangle me-2"></i>#}
{#                        Firma löschen#}
{#                    </h5>#}
{#                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>#}
{#                </div>#}
{#                <div class="modal-body">#}
{#                    <div class="text-center mb-3">#}
{#                        <i class="bi bi-building-slash display-4 text-danger mb-3"></i>#}
{#                        <h6>Möchten Sie wirklich alle Firmendaten löschen?</h6>#}
{#                    </div>#}
{#                    <div class="alert alert-warning" role="alert">#}
{#                        <i class="bi bi-exclamation-triangle me-2"></i>#}
{#                        <strong>Achtung:</strong> Alle Daten für "{{ company.company_name }}" werden unwiderruflich gelöscht.#}
{#                    </div>#}
{#                    <div class="row g-2 text-center small">#}
{#                        <div class="col-3">#}
{#                            <div class="border rounded p-2">#}
{#                                <i class="bi bi-building d-block text-muted"></i>#}
{#                                Grunddaten#}
{#                            </div>#}
{#                        </div>#}
{#                        <div class="col-3">#}
{#                            <div class="border rounded p-2">#}
{#                                <i class="bi bi-telephone d-block text-muted"></i>#}
{#                                Kontakte#}
{#                            </div>#}
{#                        </div>#}
{#                        <div class="col-3">#}
{#                            <div class="border rounded p-2">#}
{#                                <i class="bi bi-geo-alt d-block text-muted"></i>#}
{#                                Adresse#}
{#                            </div>#}
{#                        </div>#}
{#                        <div class="col-3">#}
{#                            <div class="border rounded p-2">#}
{#                                <i class="bi bi-bank d-block text-muted"></i>#}
{#                                Bankdaten#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
{#                </div>#}
{#                <div class="modal-footer">#}
{#                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">#}
{#                        <i class="bi bi-x-circle me-1"></i>#}
{#                        Abbrechen#}
{#                    </button>#}
{#                    <form method="post" action="{% url 'company:delete_company' %}" class="d-inline">#}
{#                        {% csrf_token %}#}
{#                        <button type="submit" class="btn btn-danger">#}
{#                            <i class="bi bi-trash me-1"></i>#}
{#                            Endgültig löschen#}
{#                        </button>#}
{#                    </form>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{% endblock %}

{% block extra_js %}
{#    <script src="{% static 'js/company_info.js' %}"></script>#}

    <!-- Data attributes для передачи данных в JavaScript -->
    <div style="display: none;"
         data-company-name="{{ company.company_name|escapejs }}"
         data-has-banking="{{ has_banking_data|yesno:'true,false' }}"
         data-edit-url="{% url 'company:edit_company' %}">
    </div>
{% endblock %}