{% extends 'base.html' %}
{% load static %}

{% load company_extras %}

{% block content %}
    <div class="container-fluid p-4">

        <!-- НОВОЕ: Индикатор статуса авторизации -->
        {% if not is_authenticated and admin_count > 0 %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="bi bi-info-circle me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-1">System bereit für Anmeldung</h5>
                            <p class="mb-2">Das System ist vollständig konfiguriert. Melden Sie sich an, um alle Funktionen zu nutzen.</p>
                            <button type="button" class="btn btn-primary btn-sm" onclick="window.showLoginModal && window.showLoginModal()">
                                <i class="bi bi-box-arrow-in-right me-1"></i>
                                Jetzt anmelden
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% elif is_authenticated %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-success d-flex align-items-center" role="alert">
                        <i class="bi bi-person-check me-3 fs-4"></i>
                        <div>
                            <h5 class="alert-heading mb-1">Willkommen zurück, {{ user_display_name|default:current_user.username }}!</h5>
                            <p class="mb-0">Sie sind erfolgreich angemeldet und können alle Systemfunktionen nutzen.</p>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Willkommensnachricht -->
        <div class="welcome-section mb-4">
            <div class="welcome-card">
                <div class="welcome-header mb-3">
                    <i class="bi bi-check-circle-fill text-success me-3"></i>
                    <h3 class="mb-0">System bereit!</h3>
                </div>
                <p class="welcome-text mb-0">
                    {% if has_company %}
                        Das WWS1 System ist vollständig konfiguriert und einsatzbereit für <strong>{{ company_name }}</strong>.
                        MongoDB-Verbindung aktiv, Administrator erstellt, Firma registriert.
                    {% else %}
                        MongoDB wurde erfolgreich konfiguriert und die Datenbankverbindung ist aktiv.
                        Das Warehouse Management System ist einsatzbereit.
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- НОВОЕ: Следующие шаги -->
        {% if next_steps %}
            <div class="row mb-4">
                <div class="col-12">
                    <h4><i class="bi bi-list-task me-2"></i>Nächste Schritte</h4>
                    <div class="row">
                        {% for step in next_steps %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 border-{% if step.priority == 'critical' %}danger{% elif step.priority == 'high' %}warning{% elif step.priority == 'info' %}success{% else %}secondary{% endif %}">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi {{ step.icon }} me-2 fs-4 text-{% if step.priority == 'critical' %}danger{% elif step.priority == 'high' %}warning{% elif step.priority == 'info' %}success{% else %}secondary{% endif %}"></i>
                                            <h6 class="card-title mb-0">{{ step.title }}</h6>
                                        </div>
                                        <p class="card-text small">{{ step.description }}</p>
                                        {% if step.action == 'login' %}
                                            <button type="button" class="btn btn-primary btn-sm" onclick="window.showLoginModal && window.showLoginModal()">
                                                <i class="bi bi-box-arrow-in-right me-1"></i>Anmelden
                                            </button>
                                        {% elif step.action == 'create_admin' %}
                                            <a href="{% url 'users:create_admin_step1' %}" class="btn btn-danger btn-sm">
                                                <i class="bi bi-person-plus me-1"></i>Administrator erstellen
                                            </a>
                                        {% elif step.action == 'register_company' %}
                                            <a href="{% url 'company:register_company' %}" class="btn btn-warning btn-sm">
                                                <i class="bi bi-building-add me-1"></i>Firma registrieren
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Aktionscards -->
        <div class="row g-4 mb-4">
            <!-- Firmenregistrierung (nur wenn keine Firma) -->
            {% if not has_company %}
                <div class="col-lg-4 col-md-6">
                    <div class="action-card border-warning">
                        <div class="action-header">
                            <i class="bi bi-building-add text-warning"></i>
                            <h5>Firma registrieren</h5>
                        </div>
                        <p class="action-text">
                            Registrieren Sie Ihre Firma als primäres Unternehmen im System, um die Konfiguration abzuschließen.
                        </p>
                        {% if is_authenticated %}
                            <a href="{% url 'company:register_company' %}" class="action-btn btn btn-warning">
                                <i class="bi bi-building-add me-1"></i>
                                Firma registrieren
                            </a>
                        {% else %}
                            <button type="button" class="btn btn-outline-primary" onclick="showLoginModal()">
                                <i class="bi bi-lock me-1"></i>
                                Anmeldung erforderlich1
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Lagerverwaltung -->
            <div class="col-lg-4 col-md-6">
                <div class="action-card {% if not is_authenticated %}auth-required{% endif %}">
                    <div class="action-header">
                        <i class="bi bi-box-seam"></i>
                        <h5>Lagerverwaltung</h5>
                    </div>
                    <p class="action-text">
                        Verwalten Sie Ihr Lager, fügen Sie Produkte hinzu und verfolgen Sie Bestände in Echtzeit.
                    </p>
                    {% if is_authenticated %}
                        <a href="#" class="action-btn btn btn-primary">
                            <i class="bi bi-arrow-right me-1"></i>
                            Lager öffnen
                        </a>
                    {% else %}
                        <button type="button" class="action-btn btn btn-outline-primary" onclick="window.showLoginModal && window.showLoginModal()">
                            <i class="bi bi-lock me-1"></i>
                            Anmeldung erforderlich
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Benutzerverwaltung -->
            <div class="col-lg-4 col-md-6">
                <div class="action-card {% if not is_authenticated %}auth-required{% endif %}">
                    <div class="action-header">
                        <i class="bi bi-people"></i>
                        <h5>Benutzerverwaltung</h5>
                    </div>
                    <p class="action-text">
                        Verwalten Sie Benutzerkonten, Berechtigungen und Zugriffe im System.
                    </p>
                    {% if is_authenticated %}
                        <a href="{% url 'users:create_admin_step1' %}" class="action-btn btn btn-primary">
                            <i class="bi bi-arrow-right me-1"></i>
                            Benutzer verwalten
                        </a>
                    {% else %}
                        <button type="button" class="action-btn btn btn-outline-primary" onclick="window.showLoginModal && window.showLoginModal()">
                            <i class="bi bi-lock me-1"></i>
                            Anmeldung erforderlich
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Berichte -->
            <div class="col-lg-4 col-md-6">
                <div class="action-card {% if not is_authenticated %}auth-required{% endif %}">
                    <div class="action-header">
                        <i class="bi bi-graph-up"></i>
                        <h5>Berichte</h5>
                    </div>
                    <p class="action-text">
                        Erstellen Sie detaillierte Berichte über Lagerbestände, Bewegungen und Trends.
                    </p>
                    {% if is_authenticated %}
                        <a href="#" class="action-btn btn btn-primary">
                            <i class="bi bi-arrow-right me-1"></i>
                            Berichte öffnen
                        </a>
                    {% else %}
                        <button type="button" class="action-btn btn btn-outline-primary" onclick="window.showLoginModal && window.showLoginModal()">
                            <i class="bi bi-lock me-1"></i>
                            Anmeldung erforderlich
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Systemeinstellungen -->
            <div class="col-lg-4 col-md-6">
                <div class="action-card {% if not is_authenticated %}auth-required{% endif %}">
                    <div class="action-header">
                        <i class="bi bi-gear"></i>
                        <h5>Systemeinstellungen</h5>
                    </div>
                    <p class="action-text">
                        Konfigurieren Sie Systemparameter, Sicherheitseinstellungen und Preferences.
                    </p>
                    {% if is_authenticated %}
                        <a href="#" class="action-btn btn btn-primary">
                            <i class="bi bi-arrow-right me-1"></i>
                            Einstellungen öffnen
                        </a>
                    {% else %}
                        <button type="button" class="action-btn btn btn-outline-primary" onclick="window.showLoginModal && window.showLoginModal()">
                            <i class="bi bi-lock me-1"></i>
                            Anmeldung erforderlich
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Info Cards -->
        <div class="row g-4">
            <!-- Systemstatus -->
            <div class="col-lg-4 col-md-6">
                <div class="info-card">
                    <div class="info-header">
                        <i class="bi bi-activity text-success"></i>
                        <h5>Systemstatus</h5>
                    </div>
                    <div class="status-item">
                        <i class="bi bi-database text-success"></i>
                        <span>MongoDB</span>
                        <span class="text-success">{{ mongodb_status|default:"Aktiv" }}</span>
                    </div>
                    <div class="status-item">
                        <i class="bi bi-people text-success"></i>
                        <span>Benutzer</span>
                        <span class="text-success">{{ total_users|default:0 }} aktiv</span>
                    </div>
                    <div class="status-item">
                        <i class="bi bi-building text-{% if has_company %}success{% else %}warning{% endif %}"></i>
                        <span>Firma</span>
                        <span class="text-{% if has_company %}success{% else %}warning{% endif %}">
                            {% if has_company %}Registriert{% else %}Nicht registriert{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="col-lg-4 col-md-6">
                <div class="info-card">
                    <div class="info-header">
                        <i class="bi bi-lightning text-primary"></i>
                        <h5>Quick Links</h5>
                    </div>
                    <a href="{% url 'create_database_step1' %}" class="quick-link">
                        <i class="bi bi-database-gear"></i>
                        <span>Datenbank konfigurieren</span>
                        <i class="bi bi-arrow-right"></i>
                    </a>
                    <a href="{% url 'users:create_admin_step1' %}" class="quick-link">
                        <i class="bi bi-person-plus"></i>
                        <span>Administrator erstellen</span>
                        <i class="bi bi-arrow-right"></i>
                    </a>
                    <a href="{% url 'company:register_company' %}" class="quick-link">
                        <i class="bi bi-building-add"></i>
                        <span>Firma registrieren</span>
                        <i class="bi bi-arrow-right"></i>
                    </a>
                    <a href="{% url 'company:company_info' %}" class="quick-link">
                        <i class="bi bi-info-circle"></i>
                        <span>Firmeninfo anzeigen</span>
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>

            <!-- Hilfe und Support -->
            <div class="col-lg-4 col-md-6">
                <div class="info-card">
                    <div class="info-header">
                        <i class="bi bi-question-circle text-info"></i>
                        <h5>Hilfe & Support</h5>
                    </div>
                    <a href="#" class="quick-link">
                        <i class="bi bi-book"></i>
                        <span>Dokumentation</span>
                        <i class="bi bi-arrow-right"></i>
                    </a>
                    <a href="#" class="quick-link">
                        <i class="bi bi-chat-dots"></i>
                        <span>Support kontaktieren</span>
                        <i class="bi bi-arrow-right"></i>
                    </a>
                    <a href="#" class="quick-link">
                        <i class="bi bi-question-circle"></i>
                        <span>FAQ</span>
                        <i class="bi bi-arrow-right"></i>
                    </a>
                    <a href="#" class="quick-link">
                        <i class="bi bi-tools"></i>
                        <span>System-Diagnose</span>
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}