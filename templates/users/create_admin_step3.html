{% extends 'base.html' %}

{% block content %}
    <!-- Скрываем основной контент -->
    <style>
        .main-content .welcome-section,
        .main-header .header-content,
        .main-footer {
            display: none !important;
        }
        .main-container {
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.05) 100%);
        }
    </style>

    <!-- Модальное окно -->
    <div class="modal fade show" id="adminModal" tabindex="-1" aria-labelledby="adminModalLabel" aria-modal="true" role="dialog" style="display: block;">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="adminModalLabel">
                        <i class="bi bi-shield-check me-2"></i>
                        {{ text.title }}
                    </h5>
                    <span class="badge bg-light text-dark ms-auto">Schritt {{ step }} von 3</span>
                </div>
                <div class="modal-body">

                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        {{ text.desc }}
                        <br><small class="text-muted mt-1">Administrator: <strong>{{ full_name }}</strong> ({{ username }})</small>
                    </div>

                    <form id="admin-step3-form" method="post"
                          hx-post="{% url 'create_admin_step3' %}"
                          hx-target="#toast-container"
                          hx-swap="beforeend">
                        {% csrf_token %}

                        <div class="row">
                            <!-- Systemberechtigungen -->
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="bi bi-gear me-1"></i>
                                            {{ text.permissions_title }}
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            {{ form.is_super_admin }}
                                            <label class="form-check-label" for="{{ form.is_super_admin.id_for_label }}">
                                                <strong>{{ form.is_super_admin.label }}</strong>
                                            </label>
                                            <div class="form-text">{{ form.is_super_admin.help_text }}</div>
                                        </div>

                                        <div class="form-check mb-3">
                                            {{ form.can_manage_users }}
                                            <label class="form-check-label" for="{{ form.can_manage_users.id_for_label }}">
                                                {{ form.can_manage_users.label }}
                                            </label>
                                            <div class="form-text">{{ form.can_manage_users.help_text }}</div>
                                        </div>

                                        <div class="form-check mb-3">
                                            {{ form.can_manage_database }}
                                            <label class="form-check-label" for="{{ form.can_manage_database.id_for_label }}">
                                                {{ form.can_manage_database.label }}
                                            </label>
                                            <div class="form-text">{{ form.can_manage_database.help_text }}</div>
                                        </div>

                                        <div class="form-check mb-3">
                                            {{ form.can_view_logs }}
                                            <label class="form-check-label" for="{{ form.can_view_logs.id_for_label }}">
                                                {{ form.can_view_logs.label }}
                                            </label>
                                            <div class="form-text">{{ form.can_view_logs.help_text }}</div>
                                        </div>

                                        <div class="form-check">
                                            {{ form.can_manage_settings }}
                                            <label class="form-check-label" for="{{ form.can_manage_settings.id_for_label }}">
                                                {{ form.can_manage_settings.label }}
                                            </label>
                                            <div class="form-text">{{ form.can_manage_settings.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sicherheitseinstellungen -->
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="bi bi-shield-lock me-1"></i>
                                            {{ text.security_title }}
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            {{ form.password_expires }}
                                            <label class="form-check-label" for="{{ form.password_expires.id_for_label }}">
                                                {{ form.password_expires.label }}
                                            </label>
                                            <div class="form-text">{{ form.password_expires.help_text }}</div>
                                        </div>

                                        <div class="form-check mb-3">
                                            {{ form.two_factor_required }}
                                            <label class="form-check-label" for="{{ form.two_factor_required.id_for_label }}">
                                                <strong>{{ form.two_factor_required.label }}</strong>
                                            </label>
                                            <div class="form-text">{{ form.two_factor_required.help_text }}</div>
                                        </div>

                                        <!-- Sicherheitshinweise -->
                                        <div class="alert alert-warning d-flex flex-column" role="alert">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                                                <strong>Sicherheitshinweise</strong>
                                            </div>
                                            <ul class="mb-0 ps-3 small text-muted">
                                                <li>Super-Administrator hat Vollzugriff</li>
                                                <li>2FA wird dringend empfohlen</li>
                                                <li>Regelmäßige Passwort-Änderung erhöht die Sicherheit</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Прогрессбар -->
                        <div class="mb-3" id="create-admin-progress-container" style="display: none;">
                            <label class="form-label" id="admin-progress-label">
                                <i class="bi bi-person-plus me-1"></i>
                                Administrator wird erstellt...
                            </label>
                            <div class="progress">
                                <div id="admin-progress" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <!-- Детальная информация -->
                            <div id="admin-creation-details" class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-arrow-right me-1"></i>
                                    <span id="current-step">Validierung...</span>
                                </small>
                            </div>
                        </div>

                        <!-- Прочие ошибки -->
                        {% if form.errors %}
                            <div class="alert alert-danger" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Bitte korrigieren Sie die folgenden Fehler:
                                <ul class="mb-0 mt-2">
                                    {% for field, errors in form.errors.items %}
                                        <li>{{ field }}: {{ errors|join:", " }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'create_admin_step2' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>
                                {{ text.btn_back }}
                            </a>
                            <button type="submit" class="btn btn-success" id="create-admin-btn">
                                <i class="bi bi-person-plus me-1"></i>
                                {{ text.btn }}
                            </button>
                        </div>
                    </form>

                </div>
                <div class="modal-footer">
                    <small class="text-muted">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        {{ text.notification }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Полупрозрачный фон -->
    <div class="modal-backdrop fade show"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('admin-step3-form');
            const submitBtn = document.getElementById('create-admin-btn');
            const progressContainer = document.getElementById('create-admin-progress-container');
            const progressBar = document.getElementById('admin-progress');
            const currentStepSpan = document.getElementById('current-step');

            // Отслеживаем начало HTMX запроса
            form.addEventListener('htmx:beforeRequest', () => {
                console.log('🚀 Начинаем создание администратора...');

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split spinner-border spinner-border-sm me-1" role="status"></i>Wird erstellt...';

                // Показываем прогресс-бар
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                currentStepSpan.textContent = 'Validierung der Eingaben...';

                // Симулируем прогресс
                let progress = 0;
                const steps = [
                    'Validierung der Eingaben...',
                    'Verbindung zur Datenbank...',
                    'Überprüfung auf doppelte Benutzer...',
                    'Erstelle Administrator...',
                    'Speichern in der Datenbank...',
                    'Überprüfung der Speicherung...',
                    'Abschluss...'
                ];

                let stepIndex = 0;
                window.adminProgressInterval = setInterval(() => {
                    progress += Math.floor(Math.random() * 12) + 8;
                    if (progress > 95) progress = 95;

                    progressBar.style.width = progress + '%';

                    // Обновляем текущий шаг
                    const expectedStepIndex = Math.floor((progress / 100) * steps.length);
                    if (expectedStepIndex !== stepIndex && expectedStepIndex < steps.length) {
                        stepIndex = expectedStepIndex;
                        currentStepSpan.textContent = steps[stepIndex];

                        // Анимация смены шага
                        currentStepSpan.style.opacity = '0.6';
                        setTimeout(() => {
                            currentStepSpan.style.opacity = '1';
                        }, 200);
                    }
                }, 400);
            });

            // Отслеживаем завершение HTMX запроса
            form.addEventListener('htmx:afterRequest', (event) => {
                console.log('📋 HTMX запрос завершен:', event.detail.xhr.status);

                clearInterval(window.adminProgressInterval);

                const xhr = event.detail.xhr;

                if (xhr.status === 200) {
                    console.log('✅ HTTP 200 - запрос успешен');

                    progressBar.style.width = '100%';
                    progressBar.classList.remove('bg-danger');
                    progressBar.classList.add('bg-success');
                    currentStepSpan.textContent = 'Administrator erfolgreich erstellt!';
                    currentStepSpan.style.color = '#198754';

                } else {
                    console.log('❌ HTTP ошибка:', xhr.status);

                    progressBar.classList.remove('bg-success');
                    progressBar.classList.add('bg-danger');
                    progressBar.style.width = '100%';
                    currentStepSpan.textContent = 'Fehler beim Erstellen!';
                    currentStepSpan.style.color = '#dc3545';
                }

                // Скрываем прогресс через 2 секунды
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressBar.classList.remove('bg-danger', 'bg-success');
                    progressBar.classList.add('bg-success');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-person-plus me-1"></i>{{ text.btn }}';

                    // Сброс стилей
                    currentStepSpan.style.color = '';
                    currentStepSpan.textContent = 'Validierung...';
                }, 2000);
            });

            // УЛУЧШЕННАЯ обработка успешного создания администратора
            document.body.addEventListener('htmx:afterRequest', function (event) {
                if (event.target.id === 'admin-step3-form') {
                    const xhr = event.detail.xhr;
                    console.log('🔍 Анализируем ответ...', {
                        status: xhr.status,
                        responseText: xhr.responseText.substring(0, 200) + '...'
                    });

                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            console.log('📄 JSON ответ:', response);

                            if (response && response.messages && Array.isArray(response.messages)) {
                                // Ищем сообщение об успехе
                                const hasSuccess = response.messages.some(msg => {
                                    const isSuccess = msg.tags === 'success' &&
                                        (msg.text.includes('erfolgreich erstellt') ||
                                         msg.text.includes('successfully created'));
                                    console.log('🔍 Проверяем сообщение:', {
                                        tags: msg.tags,
                                        text: msg.text.substring(0, 50) + '...',
                                        isSuccess: isSuccess
                                    });
                                    return isSuccess;
                                });

                                if (hasSuccess) {
                                    console.log('🎉 УСПЕХ! Администратор создан, перенаправляем...');

                                    // Показываем финальное уведомление
                                    showToast(
                                        'Administrator wurde erfolgreich erstellt! Weiterleitung zur Startseite...',
                                        'success',
                                        4000
                                    );

                                    // Перенаправляем через 4 секунды
                                    setTimeout(() => {
                                        console.log('🔄 Выполняем перенаправление на главную...');
                                        window.location.href = '/';
                                    }, 4000);
                                } else {
                                    console.log('⚠️  Сообщение об успехе не найдено');

                                    // Проверяем наличие ошибок
                                    const hasError = response.messages.some(msg =>
                                        msg.tags === 'error' || msg.tags === 'danger'
                                    );

                                    if (hasError) {
                                        console.log('❌ Найдены ошибки в ответе');
                                    }
                                }
                            } else {
                                console.log('⚠️  Неожиданная структура ответа:', response);
                            }
                        } catch (e) {
                            console.error('❌ Ошибка парсинга JSON:', e);
                            console.log('📄 Сырой ответ:', xhr.responseText);

                            // Если JSON не парсится, но статус 200, возможно произошел редирект
                            if (xhr.responseText.includes('erfolgreich') ||
                                xhr.responseText.includes('success') ||
                                xhr.responseText.includes('Administrator')) {
                                console.log('🔍 Обнаружен успех в тексте ответа');
                                setTimeout(() => {
                                    console.log('🔄 Перенаправляем по тексту...');
                                    window.location.href = '/';
                                }, 3000);
                            }
                        }
                    } else {
                        console.error('❌ HTTP ошибка:', xhr.status, xhr.statusText);
                    }
                }
            });

            // Включаем/отключаем зависимые чекбоксы
            const superAdminCheckbox = document.getElementById('{{ form.is_super_admin.id_for_label }}');
            const dependentCheckboxes = [
                document.getElementById('{{ form.can_manage_users.id_for_label }}'),
                document.getElementById('{{ form.can_manage_database.id_for_label }}'),
                document.getElementById('{{ form.can_view_logs.id_for_label }}'),
                document.getElementById('{{ form.can_manage_settings.id_for_label }}')
            ];

            if (superAdminCheckbox) {
                superAdminCheckbox.addEventListener('change', function () {
                    dependentCheckboxes.forEach(checkbox => {
                        if (checkbox) {
                            checkbox.checked = this.checked;
                            checkbox.disabled = this.checked;

                            // Визуальная индикация
                            const label = checkbox.closest('.form-check');
                            if (this.checked) {
                                label.style.opacity = '0.6';
                            } else {
                                label.style.opacity = '1';
                            }
                        }
                    });
                });

                // Инициализация состояния при загрузке
                if (superAdminCheckbox.checked) {
                    superAdminCheckbox.dispatchEvent(new Event('change'));
                }
            }
        });
    </script>

{% endblock %}